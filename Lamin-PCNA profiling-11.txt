var path=0;
var n=0;



Dialog.create("Welcome to Lamina profiling macro!!!");
Dialog.addMessage("Dear colleague! \n To use this macro more efficiently \n select EQUATORIAL sections of the nuclei from your stack, \n assemble together (slice 1 - lamin, slice 2 - PCNA or DAPI) \n and save as TIFF into a separate folder");
Dialog.show();

var scale=68;

var bkg=30;
var j=30;
run("ROI Manager...");

Dialog.create("Set measurement parameters");
Dialog.addNumber("No of channels", 2);
Dialog.addNumber("Lamin channel", 1);
Dialog.addNumber("PCNA channel", 2);
Dialog.addNumber("DAPI channel", 3);
Dialog.addNumber("Set scale (nm/pixel):", 30);  
Dialog.addNumber("PCNA Background level:", 1000);
Dialog.addNumber("Lamin Background level:", 1000);

 Dialog.addNumber("Profile Line width:", 1);
  
 Dialog.show();

N=Dialog.getNumber();
LamChannel=Dialog.getNumber();
PCNAChannel=Dialog.getNumber();
DAPIChannel=Dialog.getNumber();
scale=Dialog.getNumber(); 
cutoffPCNA = Dialog.getNumber();
cutoffLam=Dialog.getNumber();
 j = Dialog.getNumber();

var distancePCNA=newArray();
var distanceLam=newArray();
var widthLam=newArray();
var totalPCNA=newArray();
var totalLam=newArray();


///dir="C:\Users\Kireeev\Desktop\test\lamin-chromatin profile";
///dir2="C:\Users\Kireeev\Desktop\test\lamin-chromatin profile results";

dir=getDirectory("Select folder");
dir2=getDirectory("Select folder where to store results");

list=getFileList(dir);
for(i=0;i<list.length;i++){
	run("Bio-Formats Importer", "  open=["+dir+list[i]+"] autoscale color_mode=Default view=Hyperstack stack_order=XYCZT");
	run("Set Scale...", "distance=0 known=0 pixel=1 unit=pixel global");
	
	Dialog.create("Select EQUATORIAL slice!!!!");
	Dialog.addMessage("Select EQUATORIAL slice!!!");
	Dialog.show();

	waitForUser;
	title=getTitle();
	Stack.getPosition(channel, slice, frame);
	run("Duplicate...", "title=Slice duplicate channels=1-2 slices="+slice);
	selectWindow(title);
	close();
	
	if(N==2){
	//setBatchMode(true);
	Stack.setChannel(PCNAChannel);
	run("Subtract...", "value="+cutoffPCNA+" slice");
	resetMinAndMax();
	setSlice(LamChannel);
	run("Subtract...", "value="+cutoffLam+" slice");
	resetMinAndMax();
	Dialog.create("Draw a polyline along NE");
	Dialog.addMessage("Do not close the circle \n then do spline smoothing");
	Dialog.show();
	//setTool("polyline");
	waitForUser;
	roiManager("Add");
	roiManager("Save", dir2+title+"-Roi.zip");



///////works with only one profile per file!!!!!!!!
////	for (k=0;k<roiManager("count");k++){
		setSlice(LamChannel);
		roiManager("Select", 0);
		getSelectionCoordinates(x, y);
		leng=x.length;
		distancePCNA=newArray(leng);
		distanceLam=newArray(leng);
		widthLam=newArray(leng);
		totalPCNA=newArray(leng);
		totalLam=newArray(leng);
		print(x.length);
		n=0;


		
		//setBatchMode(true);
	for(i=4;i<x.length;i++){
		
		setSlice(LamChannel);
		makeLine(x[i-4], y[i-4], x[i], y[i],j);
		//run("Measure");
		//angle=getResult("Angle", 0);
		angle=atan2(y[i-4]-y[i], x[i]-x[i-4]);
		
		plotnormal(i,x,y,angle);
		analysis(n,distancePCNA,distanceLam,widthLam,totalLam,totalPCNA,LamChannel,PCNAChannel, DAPIChannel,N);
		n++;
		
}

distance=newArray(n);
for(i=0;i<n;i++){
	distance[i]=distancePCNA[i]-distanceLam[i];
	}




Plot.create("PCNA integrated intensity profile", "length", "a.i.", totalPCNA);
Plot.add("Lamin intensity profile",totalLam);
Plot.add("distance", distance);
Plot.update();


//Plot.create("PCNA intensity", "length", "intensity, mkm", totalPCNA);
//Plot.create("Laminintensity", "length", "intensity, mkm", totalLam);

Array.getStatistics(widthPCNA, min, max, mean, stdDev);
setResult("PCNAmean",k, mean);
setResult("PCNA-SD",k, stdDev);
setResult("PCNA-SE",k,stdDev/(sqrt(widthPCNA.length)));

print("Mean PCNA fiber width = "+mean+" mkm");
print("SD of mean PCNA fiber width = "+stdDev+" mkm");
print("SE of mean PCNA fiber width = "+stdDev/(sqrt(widthPCNA.length))+" mkm");

Array.getStatistics(widthClick,min,max,mean,stdDev);
setResult("Lamin-mean",k, mean);
setResult("Lamin-SD",k, stdDev);
setResult("Lamin-SE",k,stdDev/(sqrt(widthPCNA.length)));

print("Mean Lamin fiber width = "+mean+" mkm");
print("SD of mean Lamin fiber width = "+stdDev+" mkm");
print("SE of mean Lamin fiber width = "+stdDev/(sqrt(widthLam.length))+" mkm");
updateResults();


selectWindow("Log");
saveAs("text", dir+title);

}
//run("Dispose All Windows");
selectWindow("Results");
//saveAs("Results",dir+title+"-Results.xls");
saveAs("Measurements",dir+title+"-Measurements.xls");
run("Dispose All Windows");
run("Clear Results");
}


function plotnormal(i,x,y,angle){
	xx=-16*sin(angle)+x[i-2];
	yy=-16*cos(angle)+y[i-2];
	xxx=x[i-2]+16*sin(angle);
	yyy=y[i-2]+16*cos(angle);
	makeLine(xxx, yyy, xx, yy,j);
	}


function analysis(n,distancePCNA,distanceLam,widthLam,totalLam,totalPCNA,LamChannel,PCNAChannel, DAPIChannel,N){ ////new version of analysis function, measures all the pixes above the threshold
	selectWindow("Slice");
if(N==2){	
	

	setSlice(PCNAChannel);
	profilePCNA=getProfile();									///measure intensity of PCNA along the normal to lamin profile
	Array.getStatistics(profilePCNA,min,max);						///get min and max values of PCNA along the normal
	maxPCNA=max;
	minPCNA=min;
	//print("This is max value for PCNA profile "+maxPCNA);
	halfPCNAintensity=minPCNA+(maxPCNA-minPCNA)/2;						///define halfpeak width level
	
	
	 l = 0;
	 while ((profilePCNA[l]<=halfPCNAintensity)&&(l<32))
  		 {

			 l++;
			distancePCNA[n]=l;
    			
  		 }						//!!!!!!!!

	for(i=0;i<33;i++){
		totalPCNA[n]=totalPCNA[n]+profilePCNA[i];
			}


	setSlice(LamChannel);
	profileLam=getProfile();
	Array.getStatistics(profileLam,min,max);
	//Array.getStatistics(profileClick,max);
	//print("This is max value of Click profile "+max);
	maxLam=max;
	minLam=min;
	halfLamIntensity=minLam+(maxLam-minLam)/2;


	//run("Plot Profile");

 i = 0;
  		 do {distanceLam[n]=i;
     			 i = i + 1;
  		 } while (profileLam[i]<maxLam);

	for(i=0;i<33;i++){
		totalLam[n]=totalLam[n]+profileLam[i];
			}	


widthLam[n]=0;
for(k=0;k<profileLam.length;k++){
	if(profileLam[k]>halfLamIntensity){	
		widthLam[n]++;
		}

		}




	distancePCNA[n]=distancePCNA[n]/scale;
	
	distanceLam[n]=distanceLam[n]/scale;
	
	//print(width[n]);
	//print(MTnumber[n]);	
	
widthLam[n]=widthLam[n]/scale;
	
}
}


